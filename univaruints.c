
#include "univaruints.h"
#include <endian.h> // for be64toh
#include <string.h> // for memcpy


uint64_t shifts[]={0, 128, 16512, 2113664, 270549120, 34630287488, 4432676798592, 567382630219904, 72624976668147840};
uchar_t n_by_chr[]="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\2\3\3\3\3\3\3\3\3\3\3\3\3\3\3\3\3\4\4\4\4\4\4\4\4\5\5\5\5\6\6\7\10";

uint64_t univaruints_decode_single(const uchar_t *buf, uint64_t *used) {
  uchar_t o, n, mask;
  uint64_t pack=0;
  uchar_t *ptr=(uchar_t *)&pack;
  if (128>(o=*buf)) {
	  *used=1;
	  return (uint64_t)o;
  }
  n=n_by_chr[o];
  mask=127>>n;
  *used=n+1;
  
  memcpy(ptr+8-n, buf+1, n); // read from buf into r, buf is big-endian
  
  return shifts[n] + ( (((uint64_t)(o & mask))<< (n<<3)) | be64toh(pack) );
}
